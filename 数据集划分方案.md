# MIMII跨设备联邦学习数据集划分方案

## 数据集结构

### 实际数据组织

```
data/
├── mimii_due_fan_0db/
│   ├── id_00/
│   │   ├── normal/
│   │   └── abnormal/
│   ├── id_02/
│   │   ├── normal/
│   │   └── abnormal/
│   ├── id_04/
│   │   ├── normal/
│   │   └── abnormal/
│   └── id_06/
│       ├── normal/
│       └── abnormal/
├── mimii_dev_fan/
│   ├── train/
│   │   ├── normal/
│   │   └── abnormal/
│   └── test/
│       ├── normal/
│       └── abnormal/
└── mimii_dev_valve/
    ├── train/
    │   ├── normal/
    │   └── abnormal/
    └── test/
        ├── normal/
        └── abnormal/
```

## 数据集统计

| 客户端ID | 设备类型 | 数据来源 | Normal样本 | Abnormal样本 | 总样本数 | 异常率 |
|---------|---------|---------|------------|--------------|---------|--------|
| id_00   | Fan     | MIMII-DUE | 1,011      | 407          | 1,418   | 28.7%  |
| id_02   | Fan     | MIMII-DUE | 1,016      | 359          | 1,375   | 26.1%  |
| id_04   | Fan     | MIMII-DUE | 1,033      | 348          | 1,381   | 25.2%  |
| id_06   | Fan     | MIMII-DUE | 1,016      | 361          | 1,377   | 26.2%  |
| dev_fan | Fan     | MIMII-DEV | 3,000      | 600          | 3,600   | 16.7%  |
| dev_valve | Valve | MIMII-DEV | 3,000      | 600          | 3,600   | 16.7%  |
| **总计** | **-** | **-** | **10,076** | **2,675**    | **12,751** | **21.0%** |

## 联邦学习划分策略

### 客户端配置

系统自动检测`data/`目录下的所有可用数据集，共6个客户端：

1. **MIMII-DUE客户端（4个）**：
   - `id_00`, `id_02`, `id_04`, `id_06`
   - 设备类型：Fan（风扇）
   - 数据路径：`data/mimii_due_fan_0db/{client_id}/`
   - 数据组织：每个客户端包含`normal/`和`abnormal/`子目录

2. **MIMII-DEV客户端（2个）**：
   - `dev_fan`：设备类型Fan，数据路径：`data/mimii_dev_fan/`
   - `dev_valve`：设备类型Valve，数据路径：`data/mimii_dev_valve/`
   - 数据组织：按`train/`和`test/`划分，每个子目录包含`normal/`和`abnormal/`

### 训练/测试数据划分

#### 训练数据
- **MIMII-DUE客户端**：使用`normal/`目录下的所有Normal样本，可选混入`abnormal/`目录下的部分异常样本（默认20%比例）
- **MIMII-DEV客户端**：使用`train/normal/`目录下的所有Normal样本，可选混入`train/abnormal/`目录下的部分异常样本（默认20%比例）

#### 测试数据
- **MIMII-DUE客户端**：使用`normal/`和`abnormal/`目录下的所有样本
- **MIMII-DEV客户端**：使用`test/normal/`和`test/abnormal/`目录下的所有样本

### 音频预处理参数（统一）

```yaml
sample_rate: 16000
segment_length: 4096
n_mels: 128
hop_length: 512
n_fft: 1024
```

### 联邦学习配置

```yaml
federation:
  num_clients: 6  # 自动检测，实际可能为4-6个（取决于数据是否存在）
  client_selection: "all"  # 所有客户端参与
  num_rounds: 100
  local_epochs: 3
  lambda_proto: 0.01
  prototype_momentum: 0.7
```

## 实施细节

### 数据加载逻辑

1. **自动检测**：`get_client_ids()`函数自动扫描`data/`目录，检测可用的客户端
2. **路径解析**：
   - 以`id_`开头的客户端ID → MIMII-DUE数据集
   - `dev_fan`或`dev_valve` → MIMII-DEV数据集
3. **数据格式统一**：所有音频文件统一转换为128×T的Mel频谱图（T为时间帧数）

### 训练策略

1. **类别平衡采样**：训练时启用`BalancedBatchSampler`，确保每个batch包含约25%的异常样本
2. **客户端CMVN归一化**：每个客户端独立计算CMVN统计量，稳定特征分布
3. **全局原型对齐**：通过EMA机制（momentum=0.7）平滑聚合各客户端的本地原型

### 评估指标

- **AUC**：接收者操作特征曲线下面积（主要指标）
- **F1-Score**：精确率和召回率的调和平均
- **Precision/Recall**：精确率和召回率
- **最佳模型保存**：训练过程中自动保存AUC最高的模型checkpoint
