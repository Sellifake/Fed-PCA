# MIMII跨设备联邦学习数据集划分方案

## 方案概述

基于原始方案B，我们设计了一个更完善的跨设备联邦学习数据集划分方案，充分利用MIMII-DUE和MIMII-DEV数据集，实现真正的跨设备、跨类型异常检测。

## 数据集统计

### 可用数据集
1. **MIMII-DUE Fan**: 4个设备 (id_00, id_02, id_04, id_06)
2. **MIMII-DEV Fan**: 1个设备 (dev_fan)
3. **MIMII-DEV Valve**: 1个设备 (dev_valve)

### 详细数据统计

| 客户端ID | 设备类型 | Normal样本数 | Abnormal样本数 | 总样本数 | 异常率 | 数据来源 |
|---------|---------|-------------|---------------|---------|--------|---------|
| id_00   | Fan     | 1,011      | 407          | 1,418   | 28.7%  | MIMII-DUE |
| id_02   | Fan     | 1,016      | 359          | 1,375   | 26.1%  | MIMII-DUE |
| id_04   | Fan     | 1,033      | 348          | 1,381   | 25.2%  | MIMII-DUE |
| id_06   | Fan     | 1,016      | 361          | 1,377   | 26.2%  | MIMII-DUE |
| dev_fan | Fan     | 3,000      | 600          | 3,600   | 16.7%  | MIMII-DEV |
| dev_valve | Valve | 3,000      | 600          | 3,600   | 16.7%  | MIMII-DEV |
| **总计** | **-** | **10,076** | **2,675**    | **12,751** | **21.0%** | **-** |

## 跨设备联邦学习划分策略

### 策略1: 标准跨设备划分（推荐）
```
客户端数量: 6个
客户端类型: 4个DUE Fan + 1个DEV Fan + 1个DEV Valve
训练数据: 各客户端的Normal数据
测试数据: 各客户端的Normal + Abnormal数据
```

**优势**:
- 设备类型多样化（同类型不同设备 + 不同类型设备）
- 数据量分布相对均衡
- 符合实际工业场景
- 可以测试模型对不同设备类型的泛化能力

### 策略2: 增强跨设备划分
```
客户端数量: 8个
客户端类型: 4个DUE Fan + 2个DEV Fan + 2个DEV Valve
数据分割: 将DEV数据集按时间或随机分割为两个子客户端
训练数据: 各客户端的Normal数据
测试数据: 各客户端的Normal + Abnormal数据
```

**优势**:
- 客户端数量增加，更接近大规模联邦学习场景
- 可以测试更多客户端对性能的影响
- 数据异构性更高

### 策略3: 分层跨设备划分
```
第一层: 设备类型层
- Fan类型: 5个客户端 (4个DUE + 1个DEV)
- Valve类型: 1个客户端 (1个DEV)

第二层: 设备实例层
- 每个设备类型内部进行联邦学习
- 跨设备类型进行知识迁移
```

**优势**:
- 层次化学习，先学习设备类型内特征，再学习跨类型特征
- 可以研究设备类型间的知识迁移
- 更符合实际工业部署场景

## 推荐实施方案

### 方案A: 标准跨设备划分（主要推荐）

#### 客户端配置
```yaml
clients:
  - client_id: "id_00"
    device_type: "fan"
    data_source: "mimii_due"
    data_path: "data/mimii_due_fan_0db/id_00"
    expected_samples: 1418
    
  - client_id: "id_02"
    device_type: "fan"
    data_source: "mimii_due"
    data_path: "data/mimii_due_fan_0db/id_02"
    expected_samples: 1375
    
  - client_id: "id_04"
    device_type: "fan"
    data_source: "mimii_due"
    data_path: "data/mimii_due_fan_0db/id_04"
    expected_samples: 1381
    
  - client_id: "id_06"
    device_type: "fan"
    data_source: "mimii_due"
    data_path: "data/mimii_due_fan_0db/id_06"
    expected_samples: 1377
    
  - client_id: "dev_fan"
    device_type: "fan"
    data_source: "mimii_dev"
    data_path: "data/mimii_dev_fan"
    expected_samples: 3600
    
  - client_id: "dev_valve"
    device_type: "valve"
    data_source: "mimii_dev"
    data_path: "data/mimii_dev_valve"
    expected_samples: 3600
```

#### 数据预处理策略
```yaml
preprocessing:
  # 音频预处理（统一参数）
  sample_rate: 16000
  segment_length: 4096
  n_mels: 128
  hop_length: 512
  n_fft: 1024
  
  # 数据增强（针对不同设备类型调整）
  augmentation:
    fan_devices:
      time_stretch: [0.9, 1.1]
      volume_change: [-6, 6]  # dB
      noise_snr: [20, 40]     # dB
    valve_devices:
      time_stretch: [0.95, 1.05]  # 阀门对时间变化更敏感
      volume_change: [-3, 3]      # dB
      noise_snr: [25, 45]         # dB
```

#### 联邦学习配置
```yaml
federation:
  num_clients: 6
  client_selection: "all"  # 或 "random"
  selection_fraction: 1.0
  num_rounds: 100
  local_epochs: 5
  
  # 针对跨设备的特殊配置
  cross_device:
    enable_prototype_alignment: true
    lambda_proto: 0.1
    device_type_aware: true
    adaptive_lambda: true  # 根据设备类型调整lambda_proto
```

## 实验设计

### 基线对比实验
1. **单设备训练**: 每个客户端独立训练
2. **集中式训练**: 所有数据集中训练
3. **标准联邦学习**: 使用FedAvg
4. **Fed-ProFiLA-AD**: 我们的方法

### 跨设备泛化实验
1. **同类型设备泛化**: Fan设备间的泛化能力
2. **跨类型设备泛化**: Fan到Valve的泛化能力
3. **新设备适应**: 在部分设备上训练，在新设备上测试

### 消融实验
1. **FiLM机制的作用**: 有无FiLM调制的对比
2. **原型对齐的作用**: 不同lambda_proto值的影响
3. **设备类型感知**: 是否考虑设备类型信息的影响

## 评估指标

### 异常检测性能
- **AUC**: 接收者操作特征曲线下面积
- **F1-Score**: 精确率和召回率的调和平均
- **Precision@K**: 前K个预测的精确率
- **NDCG**: 归一化折损累积增益

### 联邦学习性能
- **收敛速度**: 达到目标性能所需的轮数
- **通信效率**: 每轮传输的参数数量
- **个性化程度**: 客户端间模型的差异度
- **泛化能力**: 在未见客户端上的性能

### 跨设备性能
- **设备内性能**: 在训练设备上的性能
- **设备间性能**: 在未训练设备上的性能
- **类型内泛化**: 同类型设备间的泛化
- **类型间泛化**: 不同类型设备间的泛化

## 实施建议

### 阶段1: 基础实现
1. 实现标准跨设备划分（方案A）
2. 修改数据加载器支持多数据集
3. 实现设备类型感知的配置

### 阶段2: 高级功能
1. 实现增强跨设备划分（方案B）
2. 添加设备类型感知的损失函数
3. 实现自适应超参数调整

### 阶段3: 实验验证
1. 运行完整的对比实验
2. 分析跨设备泛化能力
3. 优化模型架构和超参数

## 预期挑战与解决方案

### 挑战1: 数据异构性
- **问题**: 不同设备类型的数据分布差异很大
- **解决方案**: 使用设备类型感知的FiLM参数生成

### 挑战2: 通信开销
- **问题**: 6个客户端可能增加通信开销
- **解决方案**: 实现客户端选择策略和梯度压缩

### 挑战3: 收敛稳定性
- **问题**: 跨设备训练可能导致收敛不稳定
- **解决方案**: 使用学习率调度和梯度裁剪

这个跨设备划分方案既保持了联邦学习的核心特性，又充分利用了MIMII数据集的特点，为工业异常检测的跨设备联邦学习研究提供了坚实的基础。
